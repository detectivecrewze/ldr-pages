<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Distance Love | Windows 98</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;500;600;700&family=VT323&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --win-teal: #008080;
            --win-blue: #000080;
            --win-blue-light: #1084d0;
            --win-gray: #c0c0c0;
            --win-gray-light: #dfdfdf;
            --win-gray-dark: #808080;
            --win-black: #000000;
            --win-white: #ffffff;
            --border-light: #ffffff;
            --border-dark: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            user-select: none;
        }

        body {
            font-family: 'Pixelify Sans', 'MS Sans Serif', sans-serif;
            background: var(--win-teal);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Desktop Background */
        .desktop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 36px);
            background: var(--win-teal);
            background-image:
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 4px 4px;
            z-index: 0;
        }

        /* Desktop Icons Container */
        .desktop-icons {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 32px;
            max-width: calc(100% - 40px);
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            cursor: pointer;
            padding: 4px;
            border: 1px solid transparent;
            transition: all 0.1s;
        }

        .desktop-icon:hover {
            border: 1px dotted var(--win-white);
        }

        .desktop-icon.selected,
        .desktop-icon:active {
            border: 1px dotted var(--win-white);
            background: rgba(0, 0, 128, 0.3);
        }

        .desktop-icon.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.5);
        }

        .icon-img {
            font-size: 36px;
            margin-bottom: 6px;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
            filter: drop-shadow(2px 2px 0 rgba(0, 0, 0, 0.3));
        }

        .icon-text {
            font-size: 11px;
            color: var(--win-white);
            text-align: center;
            line-height: 1.3;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.9);
            word-break: break-word;
        }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .desktop-icons {
                top: 45px;
                gap: 12px;
                justify-content: flex-start;
                padding-left: 10px;
            }

            .desktop-icon {
                width: 65px;
            }

            .icon-img {
                font-size: 32px;
            }

            .icon-text {
                font-size: 10px;
            }
        }

        /* Open Window Container */
        .app-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 900px;
            height: auto;
            max-height: 90vh;
            background: var(--win-gray);
            border: 2px solid var(--border-light);
            border-right-color: var(--border-dark);
            border-bottom-color: var(--border-dark);
            box-shadow:
                1px 1px 0 var(--win-black),
                -1px -1px 0 var(--border-light),
                inset 1px 1px 0 var(--border-light),
                inset -1px -1px 0 var(--border-dark);
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .app-window.active {
            display: flex;
        }

        /* Window Title Bar */
        .window-title-bar {
            background: linear-gradient(90deg, var(--win-blue) 0%, var(--win-blue-light) 100%);
            padding: 3px 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--border-dark);
            cursor: move;
        }

        .window-title {
            color: var(--win-white);
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        .window-icon {
            font-size: 14px;
        }

        .window-controls {
            display: flex;
            gap: 2px;
        }

        .win98-btn {
            width: 18px;
            height: 16px;
            background: var(--win-gray);
            border: 2px outset var(--border-light);
            font-size: 10px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--win-black);
            font-weight: bold;
        }

        .win98-btn:active {
            border-style: inset;
        }

        /* Window Content */
        .window-content {
            flex: 1;
            overflow: auto;
            position: relative;
            min-height: 500px;
            max-height: calc(90vh - 80px);
        }

        .window-iframe {
            width: 100%;
            min-height: 500px;
            border: 2px inset var(--border-light);
            background: var(--win-white);
            display: block;
        }

        /* Loading State */
        .window-loading {
            position: absolute;
            inset: 0;
            background: var(--win-gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .window-loading.hidden {
            display: none;
        }

        .loading-text {
            font-size: 14px;
            color: var(--win-black);
            margin-bottom: 10px;
        }

        .loading-bar {
            width: 150px;
            height: 16px;
            background: var(--win-white);
            border: 2px inset var(--border-light);
            overflow: hidden;
        }

        .loading-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(180deg, #0000ff 0%, #000080 100%);
            animation: load-progress 1s ease-in-out forwards;
        }

        @keyframes load-progress {
            to {
                width: 100%;
            }
        }

        /* Taskbar */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: var(--win-gray);
            border-top: 2px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 2px 4px;
            gap: 4px;
            z-index: 1000;
            box-shadow: 0 -1px 0 var(--border-dark);
        }

        .start-button {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--win-gray);
            border: 2px outset var(--border-light);
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            margin-right: 8px;
        }

        .start-button:active {
            border-style: inset;
        }

        .start-logo {
            width: 18px;
            height: 18px;
            background: var(--win-green);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--win-white);
            box-shadow: inset 1px 1px 0 rgba(255, 255, 255, 0.3);
        }

        .taskbar-divider {
            width: 2px;
            height: 28px;
            border-left: 1px solid var(--border-dark);
            border-right: 1px solid var(--border-light);
            margin: 0 4px;
        }

        .taskbar-window {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: var(--win-gray);
            border: 2px outset var(--border-light);
            font-size: 12px;
            cursor: pointer;
            max-width: 200px;
            overflow: hidden;
        }

        .taskbar-window.active {
            border-style: inset;
            background: var(--win-gray-light);
        }

        .taskbar-window.minimized {
            opacity: 0.7;
        }

        .tb-icon {
            font-size: 14px;
        }

        .tb-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .taskbar-tray {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border: 2px inset var(--border-light);
            font-size: 12px;
        }

        .tray-time {
            min-width: 65px;
            text-align: center;
            font-family: 'VT323', monospace;
            font-size: 16px;
        }

        /* Start Menu */
        .start-menu {
            position: fixed;
            bottom: 36px;
            left: 4px;
            width: 200px;
            background: var(--win-gray);
            border: 2px outset var(--border-light);
            z-index: 1001;
            display: none;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
        }

        .start-menu.open {
            display: block;
        }

        .start-menu-header {
            background: linear-gradient(180deg, var(--win-blue) 0%, var(--win-blue-light) 100%);
            color: var(--win-white);
            padding: 6px 12px;
            font-weight: 600;
            font-size: 16px;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
        }

        .start-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .start-menu-item:hover {
            background: var(--win-blue);
            color: var(--win-white);
        }

        .start-menu-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .menu-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-text {
            flex: 1;
        }

        .menu-shortcut {
            font-size: 10px;
            color: var(--win-gray-dark);
        }

        .start-menu-item:hover .menu-shortcut {
            color: var(--win-white);
        }

        .menu-separator {
            height: 1px;
            background: var(--border-dark);
            border-top: 1px solid var(--border-light);
            margin: 4px 0;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .desktop-icons {
                top: 10px;
                left: 10px;
                right: 10px;
                gap: 16px;
            }

            .desktop-icon {
                width: 65px;
            }

            .icon-text {
                font-size: 10px;
            }

            .icon-img {
                font-size: 28px;
            }

            .app-window {
                width: 95%;
                max-height: 80vh;
            }

            .taskbar-window {
                max-width: 120px;
            }

            .tb-text {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Desktop -->
    <div class="desktop" id="desktop"></div>

    <!-- Desktop Icons -->
    <div class="desktop-icons" id="desktopIcons">
        <!-- Icons will be generated by JS -->
    </div>

    <!-- Application Window -->
    <div class="app-window" id="appWindow">
        <div class="window-title-bar" id="windowTitleBar">
            <div class="window-title">
                <span class="window-icon" id="windowIcon">üíï</span>
                <span id="windowTitleText">Long_Distance_Love.exe</span>
            </div>
            <div class="window-controls">
                <button class="win98-btn minimize" id="minimizeBtn" title="Minimize">_</button>
                <button class="win98-btn maximize" id="maximizeBtn" title="Maximize">‚ñ°</button>
                <button class="win98-btn close" id="closeBtn" title="Close">√ó</button>
            </div>
        </div>
        <div class="window-content">
            <div class="window-loading" id="windowLoading">
                <div class="loading-text">Loading...</div>
                <div class="loading-bar">
                    <div class="loading-fill"></div>
                </div>
            </div>
            <iframe class="window-iframe" id="windowIframe" src=""
                sandbox="allow-scripts allow-same-origin allow-autoplay"></iframe>
        </div>
    </div>

    <!-- Start Menu -->
    <div class="start-menu" id="startMenu">
        <div class="start-menu-header">Windows 98</div>
        <div id="startMenuItems">
            <!-- Menu items generated by JS -->
        </div>
        <div class="menu-separator"></div>
        <div class="start-menu-item" onclick="desktop.shutdown()">
            <span class="menu-icon">‚èª</span>
            <span class="menu-text">Shut Down...</span>
        </div>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
        <button class="start-button" id="startBtn">
            <span class="start-logo">‚ö™</span>
            <span>Start</span>
        </button>
        <div class="taskbar-divider"></div>
        <div id="taskbarWindows">
            <!-- Taskbar buttons generated by JS -->
        </div>
        <div class="taskbar-tray">
            <span class="tray-time" id="trayTime">12:00 PM</span>
        </div>
    </div>

    <script src="data.js?v=3"></script>
    <script>
        // Desktop Application Manager
        // Global Audio Player for persistent music
        window.bgAudio = new Audio();
        window.bgAudio.loop = false;
        window.audioState = {
            currentSongIndex: -1,
            isPlaying: false,
            playlist: []
        };

        const desktop = {
            currentApp: null,
            openApps: [],
            isStartMenuOpen: false,

            // App definitions - sequential order
            // Flow: Login -> Media Player -> Dashboard -> Journey Map -> Gallery -> Video Vault -> Messenger -> Sweeper -> Bucket List -> Quiz -> Letter
            apps: [
                {
                    id: 'login',
                    name: 'Login.exe',
                    icon: 'üîê',
                    path: 'pages/page-1-login/index.html',
                    description: 'Access your love story'
                },
                {
                    id: 'shared',
                    name: 'Media_Player.exe',
                    icon: 'üéµ',
                    path: 'pages/page-4-shared/index.html',
                    description: 'Music and memories'
                },
                {
                    id: 'dashboard',
                    name: 'Dashboard.exe',
                    icon: 'üìä',
                    path: 'pages/page-2-dashboard/index.html',
                    description: 'View connection stats'
                },
                {
                    id: 'journey',
                    name: 'Journey_Map.exe',
                    icon: 'üó∫Ô∏è',
                    path: 'pages/page-3-map/index.html',
                    description: 'Places we\'ve been together'
                },
                {
                    id: 'memories',
                    name: 'Gallery.exe',
                    icon: 'üì∑',
                    path: 'pages/page-6-memories/index.html',
                    description: 'Our precious moments'
                },
                {
                    id: 'video',
                    name: 'Video_Vault.exe',
                    icon: 'üìπ',
                    path: 'pages/page-12-video/index.html',
                    description: 'Our video memories'
                },
                {
                    id: 'messenger',
                    name: 'Love_Messenger.exe',
                    icon: 'üí¨',
                    path: 'pages/page-8-messenger/index.html',
                    description: 'Our chat history'
                },
                {
                    id: 'sweeper',
                    name: 'Heart_Sweeper.exe',
                    icon: 'üí£',
                    path: 'pages/page-9-sweeper/index.html',
                    description: 'Find the hearts!'
                },
                {
                    id: 'bucketlist',
                    name: 'Our_Bucket_List.txt',
                    icon: 'üìã',
                    path: 'pages/page-10-bucketlist/index.html',
                    description: 'Future dreams together'
                },
                {
                    id: 'quiz',
                    name: 'Quiz_Wizard.exe',
                    icon: '‚ùì',
                    path: 'pages/page-11-quiz/index.html',
                    description: 'Test our compatibility'
                },
                {
                    id: 'letter',
                    name: 'LETTER.TXT',
                    icon: 'üìÑ',
                    path: 'pages/page-7-letter/index.html',
                    description: 'A special message'
                }
            ],

            async init() {
                // Keep the original apps list for filtering later
                if (!this._allApps) {
                    this._allApps = JSON.parse(JSON.stringify(this.apps));
                }

                // Initial config load
                await this.loadConfig();

                // Load unlocked index from localStorage
                const savedIndex = localStorage.getItem('ldr_unlocked_index');
                if (savedIndex !== null) {
                    this.unlockedIndex = parseInt(savedIndex);
                } else {
                    this.unlockedIndex = 0;
                }

                // Refresh shown apps
                this.refreshApps();

                this.setupEventListeners();
                this.startClock();
            },

            async loadConfig() {
                // Baseline: Start with what's in data.js
                // Compatibility fix: Check both window.CONFIG and global CONFIG
                const baselineConfig = typeof window.CONFIG !== 'undefined' ? window.CONFIG :
                    (typeof CONFIG !== 'undefined' ? CONFIG : {});

                // Check for URL parameter ?to=ID
                const urlParams = new URLSearchParams(window.location.search);
                const cloudId = urlParams.get('to');

                if (cloudId) {
                    try {
                        console.log('[Desktop] Loading config from cloud:', cloudId);
                        const response = await fetch(`https://valentine-upload.aldoramadhan16.workers.dev/get-config?id=${encodeURIComponent(cloudId)}`);
                        if (response.ok) {
                            const cloudConfig = await response.json();
                            window.CONFIG = Object.assign(JSON.parse(JSON.stringify(baselineConfig)), cloudConfig);
                            console.log('[Desktop] Cloud config loaded successfully');
                            return; // Skip localStorage if cloud config is loaded
                        } else {
                            console.error('[Desktop] Failed to load cloud config, falling back to local');
                        }
                    } catch (e) {
                        console.error('[Desktop] Error loading cloud config:', e);
                    }
                }

                // Overlay: Try to load user edits from localStorage
                const savedJson = localStorage.getItem('ldr_config');

                if (savedJson) {
                    try {
                        const savedConfig = JSON.parse(savedJson);
                        // The savedConfig from Admin is usually the full object
                        window.CONFIG = Object.assign(JSON.parse(JSON.stringify(baselineConfig)), savedConfig);
                        console.log('[Desktop] Config loaded: Overlaid localStorage onto data.js');
                    } catch (e) {
                        console.error('[Desktop] Error parsing saved config:', e);
                        window.CONFIG = baselineConfig;
                    }
                } else {
                    window.CONFIG = baselineConfig;
                    console.log('[Desktop] Config loaded: From data.js baseline');
                }
            },

            refreshApps() {
                console.log('Refreshing apps based on config...');
                const config = window.CONFIG;
                const pageConfig = config?.pageConfig?.pages || config?.pages; // Handle both structures for safety

                if (pageConfig) {
                    // Mapping of app IDs to page IDs in config
                    const appToPageMap = {
                        'login': 'page-1',
                        'dashboard': 'page-2',
                        'journey': 'page-3',
                        'shared': 'page-4',
                        'memories': 'page-6',
                        'video': 'page-12',
                        'messenger': 'page-8',
                        'sweeper': 'page-9',
                        'bucketlist': 'page-10',
                        'quiz': 'page-11',
                        'letter': 'page-7'
                    };

                    this.apps = this._allApps.filter(app => {
                        const pageId = appToPageMap[app.id];
                        // If pageId exists in mapping, check its enabled status
                        if (pageId) {
                            const pageEntry = pageConfig[pageId];
                            // Show if entry doesn't exist or is explicitly enabled
                            return !pageEntry || pageEntry.enabled !== false;
                        }
                        return true; // Keep apps not in the map
                    }).sort((a, b) => {
                        const pageIdA = appToPageMap[a.id];
                        const pageIdB = appToPageMap[b.id];
                        const orderA = pageConfig[pageIdA]?.order || 999;
                        const orderB = pageConfig[pageIdB]?.order || 999;
                        return orderA - orderB;
                    });
                } else {
                    this.apps = JSON.parse(JSON.stringify(this._allApps));
                }

                this.renderDesktopIcons();
                this.renderStartMenu();

                // If unlockedIndex is still not defined (should be set in init)
                if (typeof this.unlockedIndex === 'undefined') {
                    this.unlockedIndex = 0;
                }

                this.updateUnlockedApps();
            },

            renderDesktopIcons() {
                const container = document.getElementById('desktopIcons');
                container.innerHTML = this.apps.map((app, index) => `
                    <div class="desktop-icon ${index > this.unlockedIndex ? 'disabled' : ''}" 
                         data-app="${app.id}" 
                         onclick="desktop.openApp('${app.id}')"
                         ondblclick="desktop.openApp('${app.id}')">
                        <div class="icon-img">${app.icon}</div>
                        <div class="icon-text">${app.name}</div>
                    </div>
                `).join('');
            },

            renderStartMenu() {
                const container = document.getElementById('startMenuItems');
                container.innerHTML = this.apps.map((app, index) => `
                    <div class="start-menu-item ${index > this.unlockedIndex ? 'disabled' : ''}" 
                         onclick="desktop.openApp('${app.id}'); desktop.toggleStartMenu();">
                        <span class="menu-icon">${app.icon}</span>
                        <span class="menu-text">${app.name}</span>
                        <span class="menu-shortcut">Ctrl+${index + 1}</span>
                    </div>
                `).join('');
            },

            updateUnlockedApps() {
                // Update which apps are clickable
                document.querySelectorAll('.desktop-icon').forEach((icon, index) => {
                    if (index <= this.unlockedIndex) {
                        icon.classList.remove('disabled');
                    } else {
                        icon.classList.add('disabled');
                    }
                });

                document.querySelectorAll('.start-menu-item').forEach((item, index) => {
                    if (index <= this.unlockedIndex) {
                        item.classList.remove('disabled');
                    } else {
                        item.classList.add('disabled');
                    }
                });
            },

            openApp(appId, force = false) {
                const app = this.apps.find(a => a.id === appId);
                if (!app) return;

                // Auto-start background music after login on first interaction with content apps
                if (window.audioState && window.audioState.currentSongIndex === -1 && appId !== 'login') {
                    this.tryStartMusic();
                }

                // Check if unlocked
                const appIndex = this.apps.findIndex(a => a.id === appId);

                if (force) {
                    // If forced (via Admin Preview), ensure this app and previous are unlocked
                    if (appIndex > this.unlockedIndex) {
                        this.unlockedIndex = appIndex;
                        this.updateUnlockedApps();
                        localStorage.setItem('ldr_unlocked_index', this.unlockedIndex);
                    }
                } else if (appIndex > this.unlockedIndex) {
                    this.showError('This application is locked. Please enter the correct password in Login.exe first.');
                    return;
                }

                this.currentApp = app;

                // Toggle window controls for Login app to prevent bypass
                const controls = document.querySelector('.window-controls');
                if (controls) {
                    controls.style.display = appId === 'login' ? 'none' : 'flex';
                }

                // Show window
                const appWin = document.getElementById('appWindow');
                const iframe = document.getElementById('windowIframe');
                const loading = document.getElementById('windowLoading');

                // Update appWin title
                document.getElementById('windowIcon').textContent = app.icon;
                document.getElementById('windowTitleText').textContent = app.name;

                // Show loading
                loading.classList.remove('hidden');
                appWin.classList.add('active');

                // Load iframe
                iframe.src = app.path;

                // Send CONFIG to iframe after it loads
                iframe.onload = () => {
                    console.log('Iframe loaded, sending CONFIG...', window.CONFIG);
                    if (window.CONFIG) {
                        iframe.contentWindow.postMessage({
                            type: 'CONFIG_UPDATE',
                            config: window.CONFIG
                        }, '*');
                    } else {
                        console.error('CONFIG not available on parent window!');
                    }
                };

                // Hide loading after delay
                setTimeout(() => {
                    loading.classList.add('hidden');
                }, 800);

                // Add to taskbar
                this.addToTaskbar(app);

                // Close start menu if open
                this.isStartMenuOpen = false;
                document.getElementById('startMenu').classList.remove('open');
            },

            closeApp() {
                const window = document.getElementById('appWindow');
                const iframe = document.getElementById('windowIframe');

                window.classList.remove('active');
                iframe.src = '';

                // Remove from taskbar
                if (this.currentApp) {
                    this.removeFromTaskbar(this.currentApp.id);
                }

                this.currentApp = null;
            },

            minimizeApp() {
                const window = document.getElementById('appWindow');
                window.classList.remove('active');

                // Update taskbar button
                if (this.currentApp) {
                    const btn = document.getElementById(`tb-${this.currentApp.id}`);
                    if (btn) btn.classList.add('minimized');
                }
            },

            restoreApp() {
                const window = document.getElementById('appWindow');
                window.classList.add('active');

                // Update taskbar button
                if (this.currentApp) {
                    const btn = document.getElementById(`tb-${this.currentApp.id}`);
                    if (btn) btn.classList.remove('minimized');
                }
            },

            addToTaskbar(app) {
                // Remove existing button if any
                this.removeFromTaskbar(app.id);

                const container = document.getElementById('taskbarWindows');
                const btn = document.createElement('div');
                btn.className = 'taskbar-window active';
                btn.id = `tb-${app.id}`;
                btn.onclick = () => {
                    const window = document.getElementById('appWindow');
                    if (window.classList.contains('active')) {
                        this.minimizeApp();
                    } else {
                        this.restoreApp();
                    }
                };
                btn.innerHTML = `
                    <span class="tb-icon">${app.icon}</span>
                    <span class="tb-text">${app.name}</span>
                `;
                container.appendChild(btn);
            },

            removeFromTaskbar(appId) {
                const btn = document.getElementById(`tb-${appId}`);
                if (btn) btn.remove();
            },

            completeApp(appId, nextAppId) {
                console.log('completeApp called:', appId, nextAppId);

                // Get the index of the app that was just completed
                const completedIndex = this.apps.findIndex(a => a.id === appId);
                console.log('Completed index:', completedIndex, 'Current unlockedIndex:', this.unlockedIndex);

                // Strategy: If a specific nextAppId is requested, we MUST ensure it is unlocked
                if (nextAppId) {
                    const nextIndex = this.apps.findIndex(a => a.id === nextAppId);
                    if (nextIndex !== -1 && nextIndex > this.unlockedIndex) {
                        console.log('Specifically requested app', nextAppId, 'is ahead. Unlocking up to index:', nextIndex);
                        this.unlockedIndex = nextIndex;
                        localStorage.setItem('ldr_unlocked_index', this.unlockedIndex);
                        this.updateUnlockedApps();
                    }
                }
                // Fallback: Just increment if we completed the current furthest app
                else if (completedIndex !== -1 && completedIndex === this.unlockedIndex) {
                    if (this.unlockedIndex < this.apps.length - 1) {
                        this.unlockedIndex++;
                        console.log('Unlocked next available app, index now:', this.unlockedIndex);
                        localStorage.setItem('ldr_unlocked_index', this.unlockedIndex);
                        this.updateUnlockedApps();
                    }
                }

                // If the app is still the current active one, close it
                if (this.currentApp && this.currentApp.id === appId) {
                    // Close the window manually to avoid recursive loops with closeApp()
                    const window = document.getElementById('appWindow');
                    const iframe = document.getElementById('windowIframe');
                    window.classList.remove('active');
                    iframe.src = '';
                    if (this.currentApp) this.removeFromTaskbar(this.currentApp.id);
                    this.currentApp = null;
                }

                // Determine which ID to auto-open
                let nextId = nextAppId;
                if (!nextId && completedIndex !== -1) {
                    // If no specific nextId, just take the next one in the current filtered list if unlocked
                    if (completedIndex + 1 <= this.unlockedIndex) {
                        nextId = this.apps[completedIndex + 1]?.id;
                    }
                }

                if (nextId && nextId !== appId) {
                    console.log('Auto-opening nextId:', nextId);
                    setTimeout(() => {
                        this.openApp(nextId);
                    }, 500);
                }
            },

            toggleStartMenu() {
                this.isStartMenuOpen = !this.isStartMenuOpen;
                document.getElementById('startMenu').classList.toggle('open', this.isStartMenuOpen);
            },

            tryStartMusic() {
                const config = window.CONFIG;
                const playlist = config?.sharedWorld?.playlist || [];

                if (playlist.length > 0 && window.audioState && window.audioState.currentSongIndex === -1 && window.bgAudio) {
                    console.log('[Desktop] Attempting background music auto-play...');

                    // Find first valid song URL
                    const firstSongIndex = playlist.findIndex(s => s.url);
                    if (firstSongIndex === -1) return;

                    const song = playlist[firstSongIndex];
                    window.bgAudio.src = song.url;

                    const playPromise = window.bgAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            window.audioState.isPlaying = true;
                            window.audioState.currentSongIndex = firstSongIndex;
                            window.audioState.playlist = playlist;
                            console.log('[Desktop] Auto-play successful');
                        }).catch(error => {
                            console.log('[Desktop] Auto-play deferred (waiting for interaction):', error);
                        });
                    }
                }
            },

            navigateBack(currentAppId) {
                const currentIndex = this.apps.findIndex(a => a.id === currentAppId);
                if (currentIndex > 0) {
                    const prevApp = this.apps[currentIndex - 1];
                    console.log('[Desktop] Navigating back to:', prevApp.id);
                    this.closeApp();
                    setTimeout(() => {
                        this.openApp(prevApp.id);
                    }, 300);
                } else {
                    console.log('[Desktop] Already at the first app, closing window.');
                    this.closeApp();
                }
            },

            showError(message) {
                alert(message); // Simple error for now
            },

            shutdown() {
                if (confirm('Are you sure you want to shut down?')) {
                    document.body.innerHTML = `
                        <div style="background: black; color: #c0c0c0; height: 100vh; display: flex; align-items: center; justify-content: center; font-family: 'Pixelify Sans', sans-serif;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 20px;">Windows 98</div>
                                <div>It is now safe to turn off your computer.</div>
                            </div>
                        </div>
                    `;
                }
            },

            setupEventListeners() {
                // Start button
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.toggleStartMenu();
                });

                // Close button
                document.getElementById('closeBtn').addEventListener('click', () => {
                    this.closeApp();
                });

                // Minimize button
                document.getElementById('minimizeBtn').addEventListener('click', () => {
                    this.minimizeApp();
                });

                // Maximize button (toggle size)
                let isMaximized = false;
                document.getElementById('maximizeBtn').addEventListener('click', () => {
                    const window = document.getElementById('appWindow');
                    isMaximized = !isMaximized;
                    if (isMaximized) {
                        window.style.width = '98%';
                        window.style.height = 'calc(100% - 50px)';
                        window.style.maxWidth = 'none';
                    } else {
                        window.style.width = '';
                        window.style.height = '';
                        window.style.maxWidth = '600px';
                    }
                });

                // Close start menu when clicking desktop
                document.getElementById('desktop').addEventListener('click', () => {
                    this.isStartMenuOpen = false;
                    document.getElementById('startMenu').classList.remove('open');
                });

                // Window dragging
                this.setupWindowDragging();

                // Listen for messages from iframe
                window.addEventListener('message', (e) => {
                    if (e.data?.type === 'CONFIG_UPDATE') {
                        console.log('[Preview] Config updated:', e.data.config);
                        window.CONFIG = e.data.config;
                        this.refreshApps();

                        // If any app is currently open, relay the update to it
                        const iframe = document.getElementById('windowIframe');
                        if (iframe && iframe.contentWindow) {
                            console.log('[Preview] Relaying config to app window...');
                            iframe.contentWindow.postMessage(e.data, '*');
                        }
                    }
                    if (e.data?.type === 'NAVIGATE_TO_PAGE') {
                        // Admin preview navigation
                        const pageId = e.data.pageId;
                        // Map page IDs to app IDs defined in desktop.apps
                        const idMap = {
                            'page-1': 'login',
                            'page-2': 'dashboard',
                            'page-3': 'journey',
                            'page-4': 'shared',
                            'page-6': 'memories',
                            'page-12': 'video',
                            'page-8': 'messenger',
                            'page-9': 'sweeper',
                            'page-10': 'bucketlist',
                            'page-11': 'quiz',
                            'page-13': 'sticky',
                            'page-7': 'letter'
                        };
                        const appId = idMap[pageId];
                        if (appId) {
                            console.log('[Preview] Navigating to:', appId);
                            // Force open even if locked for admin preview
                            this.openApp(appId, true);
                        }
                    }
                    if (e.data?.type === 'APP_COMPLETE') {
                        // App completed - unlock next and close current
                        this.completeApp(e.data.appId || this.currentApp?.id, e.data.nextApp);
                    }
                    if (e.data?.type === 'NAVIGATE' && e.data.direction === 'close') {
                        // Prevent closing Login app to avoid bypass
                        if (this.currentApp && this.currentApp.id === 'login') {
                            return;
                        }
                        // Just close the window without unlocking next
                        this.closeApp();
                    }
                    if (e.data?.type === 'NAVIGATE' && e.data.direction === 'back') {
                        // Navigate to the previous app
                        this.navigateBack(e.data.appId || this.currentApp?.id);
                    }
                    if (e.data?.type === 'CLOSE_WINDOW') {
                        this.closeApp();
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Start menu with Win key or Ctrl+Esc
                    if ((e.key === 'Meta' || (e.ctrlKey && e.key === 'Escape'))) {
                        e.preventDefault();
                        this.toggleStartMenu();
                    }

                    // App shortcuts Ctrl+1 to Ctrl+5
                    if (e.ctrlKey && e.key >= '1' && e.key <= '5') {
                        const index = parseInt(e.key) - 1;
                        if (index <= this.unlockedIndex && this.apps[index]) {
                            this.openApp(this.apps[index].id);
                        }
                    }
                });
            },

            setupWindowDragging() {
                const titleBar = document.getElementById('windowTitleBar');
                const window = document.getElementById('appWindow');
                let isDragging = false;
                let currentX, currentY, initialX, initialY;
                let xOffset = 0, yOffset = 0;

                titleBar.addEventListener('mousedown', dragStart);
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('mousemove', drag);

                function dragStart(e) {
                    if (e.target.closest('.window-controls')) return;

                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    isDragging = true;
                }

                function dragEnd() {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;
                }

                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        xOffset = currentX;
                        yOffset = currentY;

                        window.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
                    }
                }
            },

            startClock() {
                const updateTime = () => {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    document.getElementById('trayTime').textContent = timeStr;
                };

                updateTime();
                setInterval(updateTime, 1000);
            }
        };

        // Initialize desktop
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Desktop initializing...');
            try {
                await desktop.init();
                console.log('Desktop initialized successfully');

                // Auto-open Login.exe on startup
                setTimeout(() => {
                    desktop.openApp('login');
                }, 500);
            } catch (err) {
                console.error('Desktop init error:', err);
            }
        });
    </script>
</body>

</html>